import Identity from"./permissions.js";const BASE_URL="https://oorjalabs.com/apps/subs/stripe/checkout.html",premState={state:{state:LicenseUtils.State.NON_SUPPORTER,isSupporter:!1,lastRefresh:0},products:[],subs:[],reward:null,ts:null,remotePurchases:[]};async function fetchPremiumState(){updateStateVariables(await MessageSender.sendMessage({type:MessageType.GET_DATA}));let supportSectionTitleMessageId="options_nav_support";premState.state.isSupporter?(premState.state.state!=LicenseUtils.State.REWARD&&$("body").addClass("isSupporter"),$(".supporter_feature").prop("disabled",!1),$(".supporter_feature input").prop("tabIndex",0),$(".message_supporters_only").hide(),supportSectionTitleMessageId="options_support_title_supporter"):($("body").removeClass("isSupporter"),$(".supporter_feature").prop("disabled",!0),$(".supporter_feature input").prop("tabIndex",-1),$(".message_supporters_only").show()),$("a.feedback_link").attr("href",await Utils.getFeedbackUrl(premState.state.isSupporter)),$("#section-title-support").html(`${chrome.i18n.getMessage(supportSectionTitleMessageId)}<span\n                    id="support_cf_heart"></span>`)}function updateStateVariables(data){premState.state=data.state,premState.ts=data.ts,premState.products=data.products,premState.subs=data.subs,premState.reward=data.reward,premState.remotePurchases=data.remotePurchases}async function setupPurchaseSection(){setupPurchaseMessages(),premState.state.state===LicenseUtils.State.GRACE_PERIOD?($("#purchasables_description").hide(),$("#supporter_message").text("").hide(),$("#non_supporter_message").hide(),$("#stripe_expired").hide()):premState.state.isSupporter&&premState.state.state===LicenseUtils.State.SUPPORTER?showPurchased():showPurchasables(),setupRewardProductSection(),setupFindSubSection()}async function showPurchasables(){let purchasableItems;premState.products&&0!=premState.products.length?(purchasableItems=premState.products.filter((p=>p.prices&&p.prices.length>0)).reduce(((acc,product)=>{const price=product.prices[0];return acc+=`<div class="purchase_item ${product.id}" id="sku_${product.id}">\n                    <h3 class="purchase_item_title">${product.name}</h3>\n                    <p class="purchase_item_description">${product.description}</p>\n                    <div class="purchase_status pre_purchase ${product.id}"></div>\n                    <p class="purchase_item_purchase">\n                        <a href="" data-sku="${product.id}" data-priceid="${price.id}" class="buyButton button button_primary">Support</a>\n                    </p>\n                    <span class="purchase_item_price">(${price.currency.toLocaleUpperCase()} ${(price.unitAmount/100).toFixed(2)}/${price.recurring.interval})</span>\n                </div>`}),""),$("#purchasables_description").show()):(purchasableItems='<p id="no_products" class="highlightedNote highlightYellow">No supporter subscriptions available for purchase.</p>',$("#purchasables_description").hide()),$("#supporter_list_items").text("").append(purchasableItems).show(),$("#supporter_message").text("").hide()}function showPurchased(){const supportMessageRandom=Math.random();let supporterMessageId="options_supporter_message_tea_meditation";supportMessageRandom<.25?supporterMessageId="options_supporter_message_coffee_fitness":supportMessageRandom>=.25&&supportMessageRandom<.5?supporterMessageId="options_supporter_message_tea_fitness":supportMessageRandom>=.5&&supportMessageRandom<.75&&(supporterMessageId="options_supporter_message_coffee_meditation");let supporterMessage=chrome.i18n.getMessage(supporterMessageId);const firstPurchase=premState.subs[0],purchasedDate=new Date(1e3*firstPurchase.start_date).toLocaleDateString();supporterMessage+=chrome.i18n.getMessage("options_supporter_message_sku_name",[firstPurchase.name,purchasedDate]),supporterMessage+=chrome.i18n.getMessage("options_message_about_supporter_manage"),$("#supporter_message").text("").append(supporterMessage).show(),$("#non_supporter_message").hide(),$("#stripe_expired").hide(),$("#supporter_list_items").text("").hide(),$("#purchasables_description").hide()}function setupPurchaseMessages(){switch($("#supporter_message").hide(),$("#stripe_expired").hide(),premState.state.state){case LicenseUtils.State.GRACE_PERIOD:$("#gracePeriod").fadeIn();break;case LicenseUtils.State.REWARD:case LicenseUtils.State.NON_SUPPORTER:$("#non_supporter_message").fadeIn();break;case LicenseUtils.State.EXPIRED:$("#stripe_expired").fadeIn()}}function setupRewardProductSection(){var _a;if(premState.state.isSupporter&&premState.state.state!==LicenseUtils.State.REWARD)return $("#reward_code_user").hide(),void $("#reward_code_input").hide();if(premState.state.isSupporter&&premState.state.state===LicenseUtils.State.REWARD&&(null===(_a=premState.reward)||void 0===_a?void 0:_a.verified)&&premState.reward.expiry>Date.now()){const expiryDateString=new Date(premState.reward.expiry).toLocaleDateString(),rewardMessage=chrome.i18n.getMessage("options_message_reward_user",expiryDateString);$("#reward_code_user_message").text(rewardMessage),$("#reward_code_user").show(),$("#reward_code_input").hide()}else $("#reward_code_user").hide(),$("#reward_code_input").show()}async function activateRewardCode(e){e.preventDefault(),enableRewardInputs(!1);const inputElement=$("#reward_code"),statusElement=$("#reward_code_input_status"),code=inputElement.val().toString().trim();if(!code)return statusElement.text(chrome.i18n.getMessage("options_status_reward_code_input_empty")).removeClass().addClass("error"),inputElement.addClass("error"),void enableRewardInputs(!0);if(statusElement.text(chrome.i18n.getMessage("options_status_reward_code_input_pending")).removeClass().addClass("success"),code.length<48||code.length>64)return void setTimeout((()=>{statusElement.text(chrome.i18n.getMessage("options_status_reward_code_input_invalid")).removeClass().addClass("error"),inputElement.addClass("error"),enableRewardInputs(!0)}),1500);const success=await MessageSender.sendMessage({type:MessageType.SAVE_REWARD_CODE,params:[code]});return!0===success?(await fetchPremiumState(),setupPurchaseSection(),await Utils.delay(1e3),void location.reload()):!1===success?(statusElement.text(chrome.i18n.getMessage("options_status_reward_code_input_invalid")).removeClass().addClass("error"),inputElement.addClass("error"),void enableRewardInputs(!0)):void 0}function enableRewardInputs(enable){enable?($("#reward_code").prop("disabled",!1),$("#activate_reward_code").prop("disabled",!1)):($("#reward_code").prop("disabled",!0),$("#activate_reward_code").prop("disabled",!0))}function executePurchase(e){e.preventDefault();const sku=e.currentTarget.dataset.sku,priceId=e.currentTarget.dataset.priceid;console.debug("Starting purchase of",sku,priceId);const skuId=`sku_${sku}`;$(".buyButton").addClass("disabled").prop("disabled",!0),$(`#${skuId} .purchase_status`).fadeOut("fast",(()=>$(`#${skuId} .purchase_status`).removeClass("pre_purchase").addClass("purchase_in_progress").fadeIn("fast"))),priceId?Identity.requestPermission().then((granted=>{if(!granted)return showPurchaseError("Unsuccessful: No email address!",skuId),void $("#identity_message").show();executeStripePurchase(skuId,priceId)})):showPurchaseError("Error: no price available.",skuId)}async function showPurchaseError(message,skuId){$(`#${skuId} .purchase_status`).fadeOut("fast",(()=>$(`#${skuId} .purchase_status`).removeClass("pre_purchase").addClass("purchase_in_progress").fadeIn("fast"))),$(`#${skuId} .purchase_status`).fadeOut("fast",(()=>$(`#${skuId} .purchase_status`).removeClass("purchase_in_progress").addClass("purchase_cancelled").text(message).fadeIn("fast"))),await Utils.delay(5e3),$(`#${skuId} .purchase_status`).text("").removeClass("purchase_cancelled").fadeOut("fast"),$(".buyButton").removeClass("disabled").prop("disabled",!1)}async function executeStripePurchase(skuId,priceId){console.log("Starting purchase of",skuId);const email=await Utils.getEmailAddress();if(email)try{startStripeCheckout(email,priceId)}catch(error){showPurchaseError("Unable to start purchase.",skuId)}else showPurchaseError("Unsuccessful: No email address!",skuId),$("#identity_message").show(),console.debug("No email address provided. Show user error")}async function startStripeCheckout(email,priceId){const appId=chrome.runtime.id,redirectUrl=`${BASE_URL}?a=${appId}&s=${priceId}&e=${btoa(email)}&t=${GRACE_CODE}`;location.href=redirectUrl}async function openCustomerPortal(e){e.preventDefault();const url=await MessageSender.sendMessage({type:MessageType.STRIPE_GET_CUSTOMER_PORTAL_URL});url?location.href=url:($("#stripePortalError").fadeIn("fast"),await Utils.delay(3e3),$("#stripePortalError").fadeOut("slow"))}async function setupFindSubSection(){if(premState.state.isSupporter&&premState.state.state===LicenseUtils.State.SUPPORTER)return $("#button_find_sub").prop("disabled",!0),$("#identity_message").hide(),void $("#find_sub").hide();$("#find_sub").show();if(!!await Utils.getEmailAddress()){$("#identity_message").hide();let lastCheckMessage="";const fiveMinuteAgo=Date.now()-18e6,wasCheckedRecently=premState.state.lastRefresh>fiveMinuteAgo;premState.state.lastRefresh>0&&(lastCheckMessage=`Last checked ${new Date(premState.state.lastRefresh).toLocaleString()}.`,wasCheckedRecently&&(lastCheckMessage+=" Please try again after some time."),$("#find_sub_input_status").text(lastCheckMessage)),$("#button_find_sub").prop("disabled",wasCheckedRecently)}else $("#identity_message").show(),$("#button_find_sub").prop("disabled",!1)}function findExistingSubs(e){e.preventDefault(),e.currentTarget.disabled=!0,Identity.requestPermission().then((async granted=>{granted?(await MessageSender.sendMessage({type:MessageType.REFRESH_PURCHASED}),location.reload()):$(e.currentTarget).prop("disabled",!1)}))}export default{activateRewardCode:activateRewardCode,executePurchase:executePurchase,setupPurchaseSection:setupPurchaseSection,fetchPremiumState:fetchPremiumState,openCustomerPortal:openCustomerPortal,findExistingSubs:findExistingSubs,get isSupporter(){return premState.state.isSupporter}};