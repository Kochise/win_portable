Virtual Disk, Версия 1.3.3 Final
  FS-плагин для программы Total Commander, позволяющий подключать образы дисков
  в качестве дополнительных виртуальных дисков в системе.

Автор плагина: Власов Константин, 2012 г.
Домашняя страница: http://flint-inc.ru/
E-mail:            support@flint_inc.ru

Драйвер основан на open-source проекте FileDisk: Bo Branten, 2009 г.
Домашняя страница: http://www.acc.umu.se/~bosse/
E-mail:            bosse@acc.umu.se

Исходный код модифицированного драйвера и утилиты доступны на сайте проекта:
http://flint-inc.ru/rus/info/virtualdisk.html


Описание
--------

Этот плагин позволяет подключать образы дисков как дополнительные диски в системе.
Плагин работает только в системах WinNT, начиная с Windows 2000 (32- и 64-битных).
При подключении образа в системе появляется новый логический диск с заранее указанной
буквой, содержимое которого представляет собой содержимое образа.

Доступны следующие три режима работы:
  1. HDD - эмуляция локального жёсткого диска. В этом режиме можно подключать образы
     отдельных разделов жёстких дисков, отформатированных в FAT или NTFS, а также образы
     дискет и флеш-дисков с файловой системой FAT.
  2. FDD - эмуляция флоппи-диска. В этом режиме можно подключать всё то же самое, что и в
     режиме HDD, за исключением NTFS-образов (Windows не позволяет работать с системой
     NTFS на дискетах).
  3. CD/DVD - эмуляция CD-привода (с точки зрения системы различия между CD и DVD нет).
     Этот режим используется для подключения образов CD- и DVD-дисков. Допускается формат
     ISO, а также в некоторых случаях - BIN и NRG. (К сожалению, точная информация о том,
     в каких случаях BIN и NRG подключаются, а в каких - нет, пока отсутствует.)

Также для режимов HDD и FDD можно использовать модификатор "Только чтение" - в этом случае
запись на виртуальный диск будет запрещена. Эмуляция CD-привода всегда выполняется в
режиме "Только чтение".


Установка
---------

Для установки плагина просто откройте архив с плагином в панели TC, и вам будет предложено
автоматически установить плагин. Если у вас отключена функция автоустановки, см. справку
TC об установке плагинов вручную.

После этого требуется также установить драйвер, необходимый для работы плагина. Для этого
вызовите контекстное меню файла vd_filedisk.inf, находящегося в подкаталоге VD_Driver
каталога установки плагина, и выберите там команду "Установить" (в английской версии -
"Install"). Система установит драйвер vd_filedisk.sys и предложит перезагрузить компьютер.
Без перезагрузки драйвер (а следовательно, и плагин) работать не будет!

  Если у вас в контекстном меню INF-файла отсутствует команда "Установить", вы можете
  воспользоваться старым способом установки: скопировать вручную файл драйвера
  vd_filedisk.sys в каталог \Windows\system32\drivers\ , затем импортировать в реестр
  файл vd_filedisk.reg (двойным щелчком по нему) и перезагрузить компьютер.

ВНИМАНИЕ!!!
В 64-битных системах все манипуляции по установке драйвера необходимо производить только
из Проводника Windows или из 64-битной версии Total Commander! Если выполнить их из
32-битной версии TC, драйвер не будет установлен! Это связано с тем, что 32-битные
приложения работают в 64-битных Windows в режиме эмуляции 32-битного окружения, и драйвер
будет скопирован не в system32\drivers, а в SysWOW64\drivers, откуда система не сможет его
загрузить.


Работа с плагином
-----------------

После установки в TotalCommander'е в сетевом окружении появляется дополнительная папка с
названием "Virtual Disks". При заходе в эту папку выводится список файлов-образов.
Изначально этот список пустой. Добавлять образы можно простым копированием файла в эту
папку, при этом сам файл физически никуда не перемещается, запоминается только ссылка на
него. Эти ссылки можно удалить из списка обычным удалением, при этом исходный файл не
трогается.

Для настройки параметров образа нужно выбрать пункт "Свойства" из контекстного меню, или
просто нажать Enter или Alt+Enter. Появится диалоговое окно, в котором указан полный путь
к исходному файлу-образу и его текущий статус (подключён/не подключён). В этом окне можно
выбрать букву диска для подключения образа и режим (HDD/FDD/CD).
Для подключения диска нужно нажать кнопку "Подключить". Если диск уже подключён, то вместо
неё находится кнопка "Отключить".

При перезагрузке компьютера все подключённые образы становятся отключёнными. Опция
"Восстанавливать при перезагрузке" позволяет автоматически переподключить нужные диски при
загрузке компьютера: если на момент перезагрузки образ был подключён, он подключается, в
противном случае он остаётся неподключённым.
Если в процессе этого автоматического переподключения возникают какие-то ошибки, они
записываются в файл журнала VirtualDisk.log, находящийся в папке плагина.


ВАЖНЫЕ ОСОБЕННОСТИ при работе с плагином:
-----------------------------------------

1. При работе в Windows 2000 драйвер позволяет пользователям подключать файлы образов без
   проверки прав доступа NTFS. В системах, начиная с WinXP, эта проблема отсутствует.
2. При работе с плагином в многопользовательской среде невозможно подключение образов
   одного типа от имени разных пользователей. Также невозможно подключение образа через
   плагин, если в системе уже присутствует диск, подключённый через утилиту
   vd_filedisk.exe; для этого необходимо сначала отключить эти образы. Обе эти проблемы
   будут решены в будущих версиях плагина. Если вам необходима эта функциональность,
   рекомендуется подключать и отключать образы только через утилиту vd_filedisk.exe.
3. Не рекомендуется подключать/отключать диски в разных копиях TotalCommander: это может
   привести к ошибкам определения статуса образа. В большинстве случаев ошибок быть не
   должно, но этот аспект пока ещё недостаточно протестирован. На случай подобных проблем
   в диалоге свойств предусмотрена кнопка "Переключить", позволяющая поменять программное
   состояние подключения, не производя никаких реальных действий с образами.
4. CD-образы можно подключать только в режиме CD, FAT-образы - в режимах HDD и FDD, а
   NTFS-образы - только в режиме HDD. Если эти ограничения не соблюдены, то образ
   подключится, виртуальный диск появится в системе, но при обращении к нему будет выдана
   ошибка, что диск неформатирован.
5. Подключённый диск не виден программами, которые получают список дисков из списка
   системных устройств. Это связано с тем, что новый диск не является системным
   устройством, а виден только как логический диск.
6. В Windows 2000 не работает форматирование виртуального образа в FAT. Это известная
   проблема драйвера, её исправление не планируется.
7. Приложения, запущенные с повышенными привилегиями, не увидят виртуальных дисков,
   подключённых с обычными привилегиями. В результате, попытка запустить, например,
   установить программу с виртуального диска завершится ошибкой. Причина этого поведения
   в том, что виртуальный диск создаётся только для текущего пользователя, а инсталлятор
   работает от имени Администратора. Чтобы установить программу в такой ситуации, нужно
   отключить диск, запустить Total Commander с повышенными привилениями, подключить диск
   в нём и уже оттуда запускать инсталлятор.


ЧаВо (ЧАсто задаваемые ВОпросы)
-------------------------------

В. Я установил плагин, пытаюсь подключить образ, и мне выдаётся ошибка:
     Ошибка при создании виртуального диска!
     Возможно, не установлен драйвер.
О. Для корректной работы плагина требуется установить драйвер, причём это необходимо
   сделать вручную, автоматическая установка в TC устанавливает только плагин, но не
   драйвер! Как устанавливать драйвер, подробно описано выше, в разделе "Установка".

В. При попытке подключения образа выдаётся ошибка:
     Ошибка при создании виртуального диска!
     Подключено уже слишком много устройств данного типа.
О. Драйвер по умолчанию позволяет подключать только по 4 устройства каждого типа (т.е. 4
   эмулятора FDD, 4 - HDD и 4 - CD/DVD). Если вам требуется большее количество, можно
   увеличить этот параметр в реестре, ключ:
     [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\VD_FileDisk\Parameters]
     NumberOfDevices=dword:00000004
   После этого необходимо перезагрузить компьютер.

В. При подключении образа новый диск создаётся, но когда я пытаюсь его открыть, выдаётся
   ошибка.
О. Это означает, что формат образа не поддерживается плагином (а точнее - драйвером).
   Убедитесь, что вы не подключили случайно образ CD/DVD-диска как жёсткий диск или
   наоборот. Также имейте в виду, что набор поддерживаемых форматов на данный момент
   крайне ограничен (подробнее см. выше, в разделе "Описание").

В. У меня в Windows x64 плагин не подключает образы. В чём проблема?
О. Возможно, вы неправильно установили драйвер. В 64-битных системах драйвер необходимо
   устанавливать из Проводника Windows, а не из самого Total Commander, поскольку TC -
   32-битное приложение, а Windows x64 для таких приложений подменяет системные папки и
   ключи реестра; в результате при установке копирование производится не в ту папку, в
   которую должно производиться, и драйвер оказывается не установленным.


На всякий случай напишу это предупреждение:
-------------------------------------------

Программа работает с низкоуровневыми функциями Windows, что небезопасно. Я не могу
гарантировать, что программа работает абсолютно правильно и бессбойно (положение
усугубляется тем, что область программирования драйверов для меня пока малоизученная).
Посему распространяю плагин "как есть", не прилагая никаких гарантий и обещаний о
правильности работы. Используйте её на свой страх и риск.
Хочу только уточнить: по мере своих сил и возможностей я буду стараться исправлять все
найденные ошибки и недочёты. В конце концов, так как я сам пользуюсь этим плагином, я
заинтересован в его правильной работе...
