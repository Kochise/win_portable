let isAlive=!0;!function(){let state=DefaultSettings.EXTENSION_ENABLED;let premiumEnabled=!1;const me={tabId:null,windowId:null};async function getAllTabs(){try{const response=await MessageSender.sendMessage({type:MessageType.GET_TAB_LIST},!0);me.windowId=response.windowId,state=response.state,state&&parseLinks(response.tabList,!0)}catch(error){console.debug("error",error),isAlive=!1}}function parseLinks(tabList,updatingAll=!1){tabList=tabList.filter((tab=>!!tab.url&&tab.tabId!=me.tabId)),Settings.allowDuplicatesAcrossWindows&&(tabList=tabList.filter((tab=>tab.windowId==me.windowId)));const duplicateLinkClass="clutterFree_existingDuplicate "+(Settings.linkMarkers?"":"clutterFree_noIcon");if(0===tabList.length)return void(updatingAll&&$("a").removeClass(`${duplicateLinkClass} ${Theme.DARK} ${Theme.LIGHT}`).removeData("clutterfree_tabid"));const urlList=(tabList=ListControl.removeAllowedTabs(tabList)).map((tab=>{const{ignoreHash:ignoreHash,ignoreQuery:ignoreQuery}=AumControl.getIgnoreForUrl(tab.url);return Utils.cleanUrl(tab.url,{removeSuspender:!0,ignoreHash:ignoreHash,ignoreQuery:ignoreQuery,deDuplicate:!1})})),locationHref=Utils.cleanTrailingSlash(location.href).trim(),linkTheme="dark"==Utils.lightOrDark($("body"))?Theme.LIGHT:Theme.DARK;$("a").each(((i,linkElement)=>{let linkUrl=linkElement.href?Utils.cleanTrailingSlash(linkElement.href).trim():"";if(!linkUrl||linkUrl===locationHref||"#"===linkUrl)return;const{ignoreHash:ignoreHash,ignoreQuery:ignoreQuery}=AumControl.getIgnoreForUrl(linkUrl);ignoreHash&&(linkUrl=Utils.removeHash(linkUrl)),ignoreQuery&&(linkUrl=Utils.removeQuery(linkUrl));const index=urlList.indexOf(linkUrl);index>-1&&tabList[index].tabId!=me.tabId?$(linkElement).addClass(`${duplicateLinkClass} ${linkTheme}`).data("clutterfree_tabid",tabList[index].tabId):updatingAll&&$(linkElement).removeClass(`${duplicateLinkClass} ${Theme.DARK} ${Theme.LIGHT}`).removeData("clutterfree_tabid")}))}async function fetchPremiumState(){premiumEnabled=await MessageSender.sendMessage({type:MessageType.GET_IS_SUPPORTER})}$((async()=>{await Settings.init(),await fetchPremiumState(),ListControl.init(),AumControl.init(premiumEnabled);const response=await MessageSender.sendMessage({type:MessageType.WHO_AM_I});me.tabId=response.tabId,me.windowId=response.windowId,getAllTabs(),$("body").on("click","a.clutterFree_existingDuplicate",(async e=>{if(!isAlive)return;const $this=$(e.currentTarget),originalTabId=$this.data("clutterfree_tabid");if(!originalTabId||Settings.allowDuplicatesAcrossWindows&&e.shiftKey)return!0;e.preventDefault();const duplicateLinkClass="clutterFree_existingDuplicate "+(Settings.linkMarkers?"":"clutterFree_noIcon");try{await MessageSender.sendMessage({type:MessageType.SWITCH_TO_TAB,tabId:originalTabId,url:e.currentTarget.href,ctrlKey:e.ctrlKey||e.metaKey,shiftKey:e.shiftKey},!0)||($this.removeClass(duplicateLinkClass).removeData("clutterfree_tabid"),e.currentTarget.click())}catch(error){console.debug("error",error),isAlive=!1,e.currentTarget.click()}return!1})),chrome.runtime.onMessage.addListener((message=>{if(message&&isAlive&&(message.windowId&&(me.windowId=message.windowId),message.type)){if(message.type===MessageType.STATE_UPDATED)return state=message.content.state,void(state?getAllTabs():$("a.clutterFree_existingDuplicate").removeClass("clutterFree_existingDuplicate clutterFree_noIcon").removeData("clutterfree_tabid"));if(message.type!==MessageType.UPDATE_URL){if(state)switch(message.type){case MessageType.TAB_ADDED:parseLinks([message.content]);break;case MessageType.TAB_UPDATED:$("a.clutterFree_existingDuplicate").filter(((_,e)=>$(e).data("clutterfree_tabid")==message.content.tabId)).removeClass("clutterFree_existingDuplicate clutterFree_noIcon").removeData("clutterfree_tabid"),message.content.changeType==TabChangeType.TAB_ID&&(message.content.tabId=message.content.newTabId),1!=message.content.isLoadComplete&&message.content.changeType!=TabChangeType.TAB_ID||parseLinks([message.content]);break;case MessageType.TAB_REMOVED:{const removedTabIds=message.content.tabIds||[];$("a.clutterFree_existingDuplicate").filter((function(){return removedTabIds.includes($(this).data("clutterfree_tabid"))})).removeClass("clutterFree_existingDuplicate clutterFree_noIcon").removeData("clutterfree_tabid");break}}}else{if(!message.value||!message.value.url)return;message.value.replaceState?window.history.replaceState("",document.title,message.value.url):location.href=message.url}}}))})),chrome.storage.onChanged.addListener((async changes=>{if(!isAlive)return;await Settings.onChanged(changes);const listControlChanged=await ListControl.onStorageChanged(changes);changes.hasOwnProperty("premiumState")&&await fetchPremiumState();const aumListChanged=AumControl.onStorageChanged(changes,premiumEnabled);if(changes.hasOwnProperty("linkMarkers")&&changes.linkMarkers.hasOwnProperty("newValue")){changes.linkMarkers.newValue?$(".clutterFree_existingDuplicate").removeClass("clutterFree_noIcon"):$(".clutterFree_existingDuplicate").addClass("clutterFree_noIcon")}(changes.hasOwnProperty("ignoreHash")||changes.hasOwnProperty("ignoreQuery")||changes.hasOwnProperty("allowDuplicatesAcrossWindows")||changes.hasOwnProperty("allowList")||changes.hasOwnProperty("domainBlocklist")||changes.hasOwnProperty("isDomainBlocklistEnabled")||aumListChanged||listControlChanged)&&getAllTabs()}))}();const checkAlive=setInterval((async()=>{try{await MessageSender.sendMessage({type:MessageType.WHO_AM_I},!0)}catch(error){console.debug("error",error),isAlive=!1,clearInterval(checkAlive)}}),9e5);