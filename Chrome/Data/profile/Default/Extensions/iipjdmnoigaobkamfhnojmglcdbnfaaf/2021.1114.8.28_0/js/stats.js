import Premium from"./optionsPremium.js";import"./optionsCore.js";!function(){let plot;const dataSeriesObj={},plotOptions={series:{bars:{show:!0,align:"center"}},xaxis:{mode:"time",tickLength:0},yaxis:{minTickSize:1,tickDecimals:0,tickLength:0},tickFormatter:val=>new Date(val).toLocaleDateString(),grid:{borderWidth:{top:1,right:1,bottom:2,left:2},borderColor:"rgba(130,130,130,0.6)",hoverable:!0,autoHighlight:!0}};function positionHelps(){$("section").each((function(){$("#"+this.id+"Help").css({top:$(this).position().top-37})}))}function weekNumber(d,asNumber=!1){const target=new Date(d),dayNumber=(target.getDay()+6)%7;target.setDate(target.getDate()-dayNumber+3);const jan4=new Date(target.getFullYear(),0,4),dayDiff=(target.getTime()-jan4.getTime())/864e5,weekNr=1+Math.ceil(dayDiff/7),combined=target.getFullYear()+""+weekNr;return asNumber?parseInt(combined):combined}function getDateOfISOWeek(w,y){const simple=new Date(y,0,1+7*(w-1)),dow=simple.getDay(),ISOweekStart=simple;return dow<=4?ISOweekStart.setDate(simple.getDate()-simple.getDay()+1):ISOweekStart.setDate(simple.getDate()+8-simple.getDay()),ISOweekStart}$((async()=>{$("#cx-edit-help-content div").each((function(){$("#"+this.id).html(chrome.i18n.getMessage(this.id))})),positionHelps(),$("#cx-edit-help-content div").hover((e=>$(e.currentTarget).css("display","inherit")),(e=>$(e.currentTarget).css("display","none"))),$("section").hover((e=>$("#"+e.currentTarget.id+"Help").css("visibility","visible")),(e=>$("#"+e.currentTarget.id+"Help").css("visibility","hidden"))),$("section *").on("focusin",(e=>$("#"+$(e.currentTarget).parents("section").attr("id")+"Help").css("visibility","visible"))),$("section *").on("focusout",(e=>$("#"+$(e.currentTarget).parents("section").attr("id")+"Help").css("visibility","hidden"))),$(document).resize((()=>positionHelps())),await async function(){const st=await localSt.get({closedDuplicates:[]});let weeklyCount=0,monthlyCount=0;const THIS_WEEK=weekNumber((new Date).valueOf()),THIS_MONTH=(new Date).getMonth(),domainObj={};for(let i=0;i<st.closedDuplicates.length;i++){const closedDuplicate=st.closedDuplicates[i],thisDomainObj=new URL(closedDuplicate.url),thisDomain=/chrome(?:-extension)?\:/.test(thisDomainObj.protocol)?thisDomainObj.origin:thisDomainObj.hostname;weekNumber(closedDuplicate.timestamp)===THIS_WEEK&&weeklyCount++,new Date(closedDuplicate.timestamp).getMonth()===THIS_MONTH&&monthlyCount++,domainObj[thisDomain]?domainObj[thisDomain]++:domainObj[thisDomain]=1}weeklyCount>=MIN_TOTALS_DISPLAY_NOTIFICATION?$("#weekCount").text(weeklyCount.toLocaleString()):$("#week").hide();monthlyCount>=MIN_TOTALS_DISPLAY_NOTIFICATION?$("#monthCount").text(monthlyCount.toLocaleString()):$("#month").hide();if(0===st.closedDuplicates.length)$("#nada").show(),$("#totalsSection, #domainsSection").hide();else{$("#totalCount").text(st.closedDuplicates.length.toLocaleString());const domainArr=Object.keys(domainObj).map((key=>[key,domainObj[key]])).sort((function(a,b){return b[1]-a[1]}));let rowString="";for(let i=0;i<Math.min(domainArr.length,MAX_DOMAIN_ARR_ROWS);i++)rowString+=`<tr><td>${domainArr[i][0]}</td><td>${domainArr[i][1]}</td></tr>`;if(domainArr.length>MAX_DOMAIN_ARR_ROWS){let otherCount=0;for(let i=MAX_DOMAIN_ARR_ROWS+1;i<domainArr.length;i++)otherCount+=domainArr[i][1];rowString+=`<tr><td>Others</td><td>${otherCount}</td></tr>`}$("#domainStats tbody").html(rowString)}}(),await async function(){const st=await localSt.get({closedDuplicates:[]});if(st.closedDuplicates.length<=0)return void $("#chartSection").hide();const chartDataArr=[],chartDataObj={};let currentPeriod;const lastWeekNumber=weekNumber(st.closedDuplicates[st.closedDuplicates.length-1].timestamp,!0),firstWeekNumber=weekNumber(st.closedDuplicates[0].timestamp,!0);if(lastWeekNumber-firstWeekNumber>GRAPH_WEEK_THRESHOLD){for(let i=0;i<st.closedDuplicates.length;i++){let weekNum;const closedDuplicate=st.closedDuplicates[i],thisDomainObj=new URL(closedDuplicate.url),thisDomain=/chrome(?:-extension)?\:/.test(thisDomainObj.protocol)?thisDomainObj.origin:thisDomainObj.hostname;weekNum=weekNumber(closedDuplicate.timestamp),weekNum=getDateOfISOWeek(parseInt(weekNum.substr(4)),parseInt(weekNum.substr(0,4))).valueOf(),chartDataObj[weekNum]?(chartDataObj[weekNum]+=1,dataSeriesObj[weekNum].push(thisDomain)):(chartDataObj[weekNum]=1,dataSeriesObj[weekNum]=[thisDomain])}currentPeriod=weekNumber((new Date).valueOf()),currentPeriod=getDateOfISOWeek(parseInt(currentPeriod.substr(4)),parseInt(currentPeriod.substr(0,4))).valueOf(),plotOptions.series.bars.barWidth=6048e5,plotOptions.xaxis.minTickSize=[1,"day"],plotOptions.series.bars.align="left",$("#chartTitle").text("Weekly")}else{for(let i=0;i<st.closedDuplicates.length;i++){const date=new Date(st.closedDuplicates[i].timestamp).setUTCHours(0,0,0,0).valueOf();chartDataObj[date]?(chartDataObj[date]+=1,dataSeriesObj[date].push(new URL(st.closedDuplicates[i].url).hostname)):(chartDataObj[date]=1,dataSeriesObj[date]=[new URL(st.closedDuplicates[i].url).hostname])}currentPeriod=(new Date).setUTCHours(0,0,0,0).valueOf(),plotOptions.series.bars.barWidth=432e5,plotOptions.xaxis.minTickSize=[1,"day"],$("#chartTitle").text("Daily")}chartDataObj[currentPeriod]||(chartDataObj[currentPeriod]=0,dataSeriesObj[currentPeriod]=[]);for(const key in chartDataObj)chartDataArr.push([key,chartDataObj[key]]),$.unique(dataSeriesObj[key]);chartDataArr.length>MIN_GRAPH_ITEMS?plot=$("#chartDiv").plot([chartDataArr],plotOptions).data("plot"):$("#chartDiv").text("Need more data for a chart. Please check again in a few days.").css("height","auto");$("#chartDiv").bind("plothover",((event,pos,item)=>{if(item){const x=item.datapoint[0].toFixed(0),y=item.datapoint[1].toFixed(0);$("#tooltip").html(`<center><strong>${y} duplicates</strong></center><ul><li>${dataSeriesObj[x].join("</li><li>")}</li></ul>`).css({top:item.pageY-30,left:`calc(${item.pageX}px - 0.7em)`}).show()}else $("#tooltip").is(":hover")||$("#tooltip").hide()}))}(),await Premium.fetchPremiumState(),$("div#mask").fadeOut(1e3)}))}();