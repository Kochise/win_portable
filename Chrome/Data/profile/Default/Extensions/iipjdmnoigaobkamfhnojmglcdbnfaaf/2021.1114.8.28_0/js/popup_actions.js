!function(){let helpVisible=!1,closeOnEscape=!1;const activeModeSwitchMessage=chrome.i18n.getMessage("text_action_switch_mode_active"),passiveModeSwitchMessage=chrome.i18n.getMessage("text_action_switch_mode_passive");async function updateDuplicates(){const duplicateCount=(await MessageSender.sendMessage({type:MessageType.GET_DUPLICATES_LIST})).filter((d=>d.isDuplicate)).length;$("#duplicates_header").removeClass("disabled"),$("#header_duplicate_count").text(duplicateCount>0?` (${duplicateCount})`:""),$("#duplicates_actions").hide()}function navigateActionList(direction){const tabItems=$(".tabs_action.is_button:visible:not([disabled])"),highlightedTabIndex=tabItems.index($(".tabs_action.highlighted"));$(".tabs_action.highlighted").removeClass("highlighted"),-1==highlightedTabIndex?tabItems.filter(direction===KeyboardTraverse.UP?":last":":first").addClass("highlighted"):tabItems.length-1===highlightedTabIndex&&direction===KeyboardTraverse.DOWN?tabItems.filter(":first").addClass("highlighted"):0===highlightedTabIndex&&direction===KeyboardTraverse.UP?tabItems.filter(":last").addClass("highlighted"):tabItems.filter(`:eq(${highlightedTabIndex+direction})`).addClass("highlighted"),focusNavigated()}function focusNavigated(){const highlighted=$(".tabs_action.highlighted")[0];highlighted&&highlighted.scrollIntoViewIfNeeded()}$((async()=>{helpVisible=PopupCore.showHelp(helpVisible);const acsShown=parseInt(localStorage.acsShown||0);if(acsShown>=5)$("#acs_card").hide();else{!(await localSt.get({acsInstalled:!1})).acsInstalled&&$("#acs_card").hide(),localStorage.acsShown=acsShown+1}const response=await MessageSender.sendMessage({type:MessageType.GET_EXTENSION_STATE});$("#toggleStateLink").text(response.value?passiveModeSwitchMessage:activeModeSwitchMessage),updateDuplicates(),chrome.commands.getAll((commands=>{const err=chrome.runtime.lastError;err?console.warn("Error getting commands",err):commands&&commands.length>0&&commands.forEach((command=>{if(command.shortcut){const commandNode=$(`#${command.name}Link`);commandNode.html(`${commandNode.text()} <code class="action_keyboard_shortcut">${command.shortcut}</code>`)}}))})),$("main").on({click:e=>{switch(e.currentTarget.id){case"toggleStateLink":MessageSender.sendMessage({type:MessageType.TOGGLE_STATE}).then((response=>$(e.currentTarget).text(response.value?passiveModeSwitchMessage:activeModeSwitchMessage)));break;case"showOptionsLink":chrome.runtime.openOptionsPage(),window.close();break;case"listDuplicatesLink":location.href=Urls.POPUP.DUPLICATES;break;case"closeDuplicatesLink":MessageSender.sendMessage({type:MessageType.REMOVE_EXISTING_DUPLICATES,params:[!0]});break;case"recoverLostLink":MessageSender.sendMessage({type:MessageType.RESTORE_LOST});break;case"cws_acs_link":chrome.tabs.create({url:e.currentTarget.dataset.href});break;case"support_action":chrome.tabs.create({url:Urls.OPTIONS+OptionsSectionReference.SUPPORT});break;default:console.debug("Unhandled action",e.currentTarget.id)}},mouseenter:()=>function(){const tabItems=$(".tabs_action.is_button:visible:not([disabled])");$(".tabs_action.highlighted").removeClass("highlighted");const selectedTabIndex=tabItems.index($(".tabs_action.is_button:hover"));tabItems.filter(`:eq(${selectedTabIndex})`).addClass("highlighted"),focusNavigated()}()},".is_button:not([disabled])"),$("#acs_card").on("mouseenter",(e=>{$(".tabs_action.highlighted").removeClass("highlighted"),$("#cws_acs_link").addClass("highlighted"),focusNavigated()})),$("a#keyboard_help").on("click",(e=>{helpVisible=PopupCore.showHelp(!0),e.preventDefault()})),$(document).keydown((e=>{if(closeOnEscape&&e.which!=KEYCODE.ESCAPE)return closeOnEscape=!1,Toast.clear({speed:"fast"}),e.preventDefault(),void e.stopImmediatePropagation();if(!(e.ctrlKey||e.altKey||e.metaKey)){if(helpVisible)return e.preventDefault(),void(helpVisible=PopupCore.showHelp(!1));switch(e.which){case KEYCODE.UP:e.preventDefault(),navigateActionList(KeyboardTraverse.UP);break;case KEYCODE.DOWN:e.preventDefault(),navigateActionList(KeyboardTraverse.DOWN);break;case KEYCODE.ENTER:e.preventDefault(),$(".tabs_action.highlighted").click();break;case KEYCODE.ESCAPE:e.preventDefault(),$(".tabs_action.highlighted").length>0?$(".tabs_action.highlighted").removeClass("highlighted"):closeOnEscape?window.close():(Toast.showToast({text:"Press ESC again to close, any other key to keep open",duration:Toast.DURATION.INDEFINITE}),closeOnEscape=!0);break;case KEYCODE.F1:e.preventDefault(),helpVisible=PopupCore.showHelp(!0)}}})),$(document).keypress((e=>{if(e.ctrlKey||e.metaKey)return;if(helpVisible)return e.preventDefault(),void(helpVisible=PopupCore.showHelp(!1));if("?"===e.key.toUpperCase())e.preventDefault(),helpVisible=PopupCore.showHelp(!0)})),chrome.runtime.onMessage.addListener((message=>{message&&message.type&&message.type==MessageType.UPDATE_DUPLICATES&&updateDuplicates()}))}))}();