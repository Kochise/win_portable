!function(){let helpVisible=!1;let hoverFocusTimer;const searchParam=location.search.substr(1),urlParams=Utils.parseQuery(searchParam),isAttached=urlParams&&urlParams.attached;let closeOnEscape=!1;async function refreshDuplicateList(){let duplicateTabs=await MessageSender.sendMessage({type:MessageType.GET_DUPLICATES_LIST});duplicateTabs=function(duplicateList){const sortedList=[],originalTabs=duplicateList.filter((t=>!t.isDuplicate));originalTabs.sort(((t1,t2)=>{let order=t1.windowId-t2.windowId;return 0==order&&(order=t1.index-t2.index),order}));const duplicates=duplicateList.filter((t=>t.isDuplicate));return originalTabs.forEach((t=>{sortedList.push(t),duplicates.filter((tl=>tl.originalTabId==t.tabId)).forEach((tl=>sortedList.push(tl)))})),sortedList}(duplicateTabs);const duplicateCount=duplicateTabs.filter((t=>t.isDuplicate)).length;$("#duplicate_tabs_count").text(1==duplicateCount?chrome.i18n.getMessage("text_duplicate_tabs_count_one"):chrome.i18n.getMessage("text_duplicate_tabs_count_other",duplicateCount+"")),$("#header_duplicate_count").text(duplicateCount>0?` (${duplicateCount})`:"");const duplicateTabListString=duplicateTabs.reduce(((acc,t)=>acc+function(tab){const isSuspended=Suspender.isSuspended(tab.url);return tab.url=Utils.cleanUrl(tab.url),`\n        <div class="tab_item ${tab.isDuplicate?"is_duplicate":"is_original"}" id="${tab.tabId}">\n            <div class="tab_item_pinned ${tab.pinned?"is_pinned":""}" title="${tab.pinned?tab.isDuplicate?titleTabPinnedTab:titleTabPinnedTabWithDuplicate:""}"></div>\n            <div class="tab_item_title">${tab.title}</div>\n            <div class="tab_item_url">${isSuspended?`(${textTabSuspended}) `:""}${tab.url}</div>\n            <div class="tab_item_action_delete" data-id="${tab.tabId}" alt="${titleButtonCloseTab}" title="${titleButtonCloseTab}"></div>\n        </div>\n        `}(t)),"");$("#tab_host").text("").append(duplicateTabListString),duplicateCount>0&&highlightNavigated({focusCloseAll:!0})}$(document).ready((()=>{helpVisible=PopupCore.showHelp(helpVisible),refreshDuplicateList(),$("main").on({click:e=>{e.preventDefault(),e.stopImmediatePropagation();const tabId=parseInt(e.currentTarget.id);if($(`#${tabId}`).hasClass("highlighted")||navigateToHovered(),e.target.classList.contains("tab_item_action_delete"))return closeTab(tabId);focusHighlightedTab()},mouseenter:()=>navigateToHovered()},".tab_item"),$("#action_close_all_duplicates").on({mouseenter:()=>highlightNavigated({focusCloseAll:!0}),click:e=>{"refresh_duplicates"!=e.target.id?closeAllDuplicates():refreshDuplicateList()}}),$("a#keyboard_help").on("click",(e=>{helpVisible=PopupCore.showHelp(!0),e.preventDefault()})),$(document).keydown((e=>{if(closeOnEscape&&e.which!=KEYCODE.ESCAPE)return closeOnEscape=!1,Toast.clear({speed:"fast"}),e.preventDefault(),void e.stopImmediatePropagation();if(!(e.ctrlKey||e.altKey||e.metaKey)){if(helpVisible)return e.preventDefault(),void(helpVisible=PopupCore.showHelp(!1));switch(e.which){case KEYCODE.UP:e.preventDefault(),navigateTabList(KeyboardTraverse.UP);break;case KEYCODE.DOWN:e.preventDefault(),navigateTabList(KeyboardTraverse.DOWN);break;case KEYCODE.PAGEUP:e.preventDefault(),navigateTabListByPage(KeyboardTraverse.UP);break;case KEYCODE.PAGEDOWN:e.preventDefault(),navigateTabListByPage(KeyboardTraverse.DOWN);break;case KEYCODE.HOME:e.preventDefault(),e.stopImmediatePropagation(),navigateTabList(KeyboardTraverse.UP,!0);break;case KEYCODE.END:e.preventDefault(),e.stopImmediatePropagation(),navigateTabList(KeyboardTraverse.DOWN,!0);break;case KEYCODE.ENTER:if(e.preventDefault(),$("#action_close_all_duplicates .is_button").hasClass("selected"))return void closeAllDuplicates();focusHighlightedTab();break;case KEYCODE.ESCAPE:e.preventDefault(),$(".highlighted").length>0?$(".highlighted").removeClass("highlighted"):closeOnEscape?window.close():(Toast.showToast({text:chrome.i18n.getMessage("toast_text_press_escape_again_to_close"),duration:Toast.DURATION.INDEFINITE}),closeOnEscape=!0);break;case KEYCODE.DELETE:e.preventDefault(),closeTab();break;case KEYCODE.F1:e.preventDefault(),helpVisible=PopupCore.showHelp(!0)}}})),$(document).keypress((e=>{if(e.ctrlKey||e.metaKey)return;if(helpVisible)return e.preventDefault(),void(helpVisible=PopupCore.showHelp(!1));return"?"==e.key.toUpperCase()?(e.preventDefault(),void(helpVisible=PopupCore.showHelp(!0))):void 0})),chrome.runtime.onMessage.addListener((message=>{message&&message.type&&message.type==MessageType.UPDATE_DUPLICATES&&refreshDuplicateList()}))}));const titleTabPinnedTab=chrome.i18n.getMessage("title_tab_pinned_tab"),titleTabPinnedTabWithDuplicate=chrome.i18n.getMessage("title_tab_pinned_tab_with_duplicate"),titleButtonCloseTab=chrome.i18n.getMessage("title_button_close_tab"),textTabSuspended=chrome.i18n.getMessage("text_tab_suspended");function highlightDuplicates(show){$(".tab_item.is_duplicate")[show?"addClass":"removeClass"]("indicate")}async function closeAllDuplicates(){await MessageSender.sendMessage({type:MessageType.REMOVE_EXISTING_DUPLICATES}),refreshDuplicateList()}function navigateTabList(direction,toEnd=!1){const tabItems=$("#tab_host .tab_item"),highlightedTabIndex=tabItems.index($(".highlighted"));let focusCloseAll=!1;$(".highlighted").removeClass("highlighted"),toEnd?tabItems.filter(direction===KeyboardTraverse.UP?":first":":last").addClass("highlighted"):-1==highlightedTabIndex?tabItems.filter(direction===KeyboardTraverse.UP?":last":":first").addClass("highlighted"):tabItems.length-1===highlightedTabIndex&&direction===KeyboardTraverse.DOWN||0===highlightedTabIndex&&direction===KeyboardTraverse.UP?focusCloseAll=!0:tabItems.filter(`:eq(${highlightedTabIndex+direction})`).addClass("highlighted"),highlightNavigated({direction:direction,toEnd:toEnd,focusCloseAll:focusCloseAll})}function navigateTabListByPage(direction){const height=$("main").height()*direction,tabItems=$("#tab_host .tab_item"),highlightedTabIndex=tabItems.index($(".highlighted"));let newHighlightedTabIndex=highlightedTabIndex;$(".highlighted").removeClass("highlighted");let cumHeight=height*direction;return direction==KeyboardTraverse.DOWN?(tabItems.each(((i,el)=>{i<highlightedTabIndex||newHighlightedTabIndex!=highlightedTabIndex||(cumHeight-el.offsetHeight<0?newHighlightedTabIndex=i:cumHeight-=el.offsetHeight)})),newHighlightedTabIndex==highlightedTabIndex&&(newHighlightedTabIndex=tabItems.length-1)):($(tabItems.get().reverse()).each(((i,el)=>{i<tabItems.length-highlightedTabIndex||newHighlightedTabIndex!=highlightedTabIndex||(cumHeight-el.offsetHeight<0?newHighlightedTabIndex=tabItems.length-i:cumHeight-=el.offsetHeight)})),newHighlightedTabIndex==highlightedTabIndex&&(newHighlightedTabIndex=0)),tabItems.filter(`:eq(${newHighlightedTabIndex})`).addClass("highlighted"),0==newHighlightedTabIndex?highlightNavigated({direction:KeyboardTraverse.UP,toEnd:!0}):newHighlightedTabIndex==tabItems.length-1?highlightNavigated({direction:KeyboardTraverse.DOWN,toEnd:!0}):void highlightNavigated()}function navigateToHovered(){const tabItems=$("#tab_host .tab_item");$(".highlighted").removeClass("highlighted");const selectedTabIndex=tabItems.index($(".tab_item:hover"));tabItems.filter(`:eq(${selectedTabIndex})`).addClass("highlighted"),highlightNavigated()}function focusInBrowser(tabId){tabId&&!isAttached&&MessageSender.sendMessage({type:MessageType.SWITCH_TO_TAB,params:[tabId,!1],fromPopup:!0})}function highlightNavigated(details={}){if(details.focusCloseAll)return $("#action_close_all_duplicates .is_button").addClass("selected"),document.getElementsByTagName("main")[0].scrollTop=0,$(".highlighted").removeClass("highlighted"),void highlightDuplicates(!0);$("#action_close_all_duplicates .is_button").hasClass("selected")&&($("#action_close_all_duplicates .is_button").removeClass("selected"),highlightDuplicates(!1));const highlighted=$(".highlighted")[0];highlighted&&(details.toEnd?document.getElementsByTagName("main")[0].scrollTop=details.direction===KeyboardTraverse.UP?document.getElementsByTagName("main")[0].clientHeight:document.getElementsByTagName("main")[0].scrollHeight:highlighted.scrollIntoViewIfNeeded(),clearTimeout(hoverFocusTimer),hoverFocusTimer=setTimeout(focusInBrowser,600,parseInt(highlighted.id)))}function focusHighlightedTab(){let tabId=$(".highlighted").attr("id");tabId||1!=$("#tab_host .tab_item").length||(tabId=$("#tab_host .tab_item:first").attr("id")),focusInBrowser(parseInt(tabId))}function closeTab(tabId){const highlightedTabId=$(".highlighted").attr("id");(tabId||highlightedTabId)&&(tabId=null!=tabId?tabId:parseInt(highlightedTabId),chrome.tabs.get(tabId,(tab=>{!chrome.runtime.lastError&&tab&&chrome.tabs.remove(tab.id,(()=>{$(`#${tab.id}`).removeClass("highlighted").fadeOut((()=>setTimeout(refreshDuplicateList,1500)))}))})))}}();